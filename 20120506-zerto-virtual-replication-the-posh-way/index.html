<!DOCTYPE html>
<html dir='ltr' lang='en' xmlns:fb='http://ogp.me/ns/fb#'>
<head>
<link href="../stylesheets/syntax_highlighting.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='text/html;' http-equiv='content-type'>
<title>Zerto Virtual Replication the PoSh way.
 | Novosco Tech Blog</title>
<meta content='index,follow' name='robots'>
<meta content='initial-scale=1.0 maximum-scale=1.0 user-scalable=no' name='viewport'>
<meta content='width=380, maximum-scale=1.0' name='viewport'>
<link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='../images/touch-icon-iphone.png' rel='apple-touch-icon'>
<link href='../images/touch-icon-ipad.png' rel='apple-touch-icon' sizes='72x72'>
<link href='../images/touch-icon-iphone-retina.png' rel='apple-touch-icon' sizes='114x114'>
<link href='../images/touch-icon-ipad-retina.png' rel='apple-touch-icon' sizes='144x144'>
<!--[if lt IE 9]> <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
<link href="../stylesheets/all.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<!-- OG -->
<meta content='Novosco Tech Blog' property='og:title'>
<meta content='website' property='og:type'>
<meta content='../images/novosco-og-icon.png' property='og:image'>
<meta content='http://engineering.novosco.com' property='og:url'>
<meta content='Novosco Tech Blog ' property='og:description'>
<!-- Twitter -->
<meta content='summary' name='twitter:card'>
<meta content='http://engineering.novosco.com' name='twitter:url'>
<meta content='Novosco Tech Blog' name='twitter:title'>
<meta content='Novosco Tech Blog ' name='twitter:description'>
<meta content='../images/novosco-og-icon.png' name='twitter:image'>
<meta content='@novoscoeng' name='twitter:site'>
<meta content='@novosco' name='twitter:creator'>
<meta content='' name='author'>
<!-- Typekit -->
<script src="//use.typekit.net/tjm4emr.js" type="text/javascript"></script>
<script>
  try{Typekit.load();}catch(e){};
  
  window.onload = function() {
    var menu = document.getElementById('menu-button');
    var menu_items = document.getElementById('menu-items');
  
    function toggleMenu(){
      if (menu_items.style.display == "block") {
        menu_items.style.display = 'none';
      } else {
        menu_items.style.display = 'block';
      }
    };
  
    menu.addEventListener('click', function() {
      toggleMenu()
    }, false);
  };
</script>

</head>
<body class='20120506-zerto-virtual-replication-the-posh-way 20120506-zerto-virtual-replication-the-posh-way_index'>
<header>
<div class='layout-wrapper'>
<div class='layout-inner'>
<a href="/"><span class='logo'>Novosco Tech Blog</span></a>
<div class='header-nav'>
<nav>
<a href='#' id='menu-button'>
MENU
<img src='/images/menu-triangle.png' width='11px'>
</a>
<ul id='menu-items'>
<li>
<a href="http://www.novosco.com/">Home</a>
</li>
<li>
<a class="active" href="http://cio.novosco.com/">CIO Blog</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</header>

<div class='container'>
<div id='post-main'>
<article class='post-header'>
<h1 class='article-header'>
<a href="/20120506-zerto-virtual-replication-the-posh-way/">Zerto Virtual Replication the PoSh way.</a>
</h1>
<div class='post-meta'>
<div class='post-avatar'>
<img src="../images/avatars/steven-johnston.jpg?1439193430" />
</div>
<div class='post-meta-text'>
<span>By <a href="/steven-johnston">Steven Johnston</a> on</span>
<time> 6 May 2012</time>
</div>
</div>

<div class='body'>
<p>Recently I have had the pleasure of deploying Zerto Virtual Replication ( <a href="http://www.zerto.com/">http://www.zerto.com/</a>). My first impressions are very good, it’s a well polished product. The install and configuration was very straightforward and it worked without glitches. ZVR deals with all the replication and even reconfigures the networking i.e. re-IP’ing at the DR site, this is all made effortless. The replication is asynchronous and during our testing over a 100Mbit link we set the RPO to 2 minutes but were seeing actual RPO’s of around 12 seconds which is impressive.</p>

<p></p>

<p>The architecture hinges around having a management server at each site called the Zerto Virtual Manager (ZVM) and having Virtual Replication Appliances (VRA) on each ESXi host. The product uses the concept of the Virtual Protection Group’s (VPG) to collate machines together with common configuration such as RPO and Journal CDP History which affects the point to which you can roll back to. When the VPG’s are protected you have the option to Move, Failover or Test the Failover. Among the configuration options on the VPG’s there are Pre and Post Scripts and this is where PowerShell (PoSh) comes in very handy. This post was inspired by a requirement at a customer’s site and focuses on a DNS record update script you may need to finish off your deployment.</p>

<p>The Admin Guide is well put together, provides good guidance on the configuration and suggests some additional functionality you may wish to provide by using scripts. Functionality suggested includes updating DNS records at the DR site after Failover and also recording Failover Testing in text files on the Zerto Virtual Manager servers. I decided to put all this functionality into one PowerShell script since both of these suggestions are great, updating DNS is an absolute must and recording Test Failovers seems sensible. I used the DNS Update powershell script from the Admin Guide as the basis for my script and added extra bits so only a single script is required for all VPG’s and so the Failover Test history is recorded using the same script (the Admin Guide has a separate batch file script to do this).</p>

<p>I realised DNS should only be updated if a Move or an actual Failover occurred. Failover Testing brings VMs up in your VM Port Group of choice but it’s very likely you’ll use an isolated network so definitely don’t want to change production DNS records. Zerto make achieving these goals easier by providing environment variables such as<br>
<code>%ZertoOperation%</code> with values of Move, Failover or Test and<br>
<code>%ZertoVPGName%</code> which contains the VPG name.<br>
These Environment variables are explained in the Admin Guide and I have used them within my script.</p>

<p>The Post Script uses a Powershell ps1 file, Dnscmd.exe and a subfolder per VPG which contains 4 csv files. Dnscmd.exe is wrapped in the Powershell script and updates DNS records using the relevant csv files.<br>
Dnscmd.exe can be installed on Windows Server 2008 R2 from the Features menu and for this script to run the executable needs copied to the script directory “C:\ZertoScripts\”.</p>

<p>The script is run from the site you are failing over to, a common path on both ZVM servers should be used for scripts to ensure they run when you failover and failback again. Also the service account you use for Zerto will require local admin privileges and needs to be added to the DNSAdmins group so the DNS records can be updated. Note that the csv file contents will be different for the VPG’s at each site as you will want to change DNS to use the IP’s for whichever site you are moving the VM’s to. The script deletes old DNS entries and imports new ones to replace them.</p>

<p>The script directory “C:\ZertoScripts\” should contain the following files. Note VPGName1 is an example subdirectory named exactly the same as the VPG name and will have 4 csv files within it.<br>
<code>
DNS-Change.ps1  
Dnscmd.exe  
VPGName1\DNS-NewA.csv  
VPGName1\DNS-NewPTR.csv  
VPGName1\DNS-OldA.csv  
VPGName1\DNS-OldPTR.csv  
</code></p>

<p>In the Zerto tab within vCenter under the VPG’s options you’ll find the Post Script options. For this script they need to be configured as follows:<br>
<strong>Command:</strong> %SystemRoot%\system32\WindowsPowerShell\v1.0\powershell.exe<br>
<strong>Params:</strong> C:\ZertoScripts\DNS-Change.ps1 %ZertoOperation% %ZertoVPGName%</p>

<p><strong>DNS-Change.ps1 contains the following:</strong></p>

<h4>Zerto Failover Script</h4>

<p>## Timestamp
 $timestamp = get-date -format &ldquo;dd-MM-yy_HHmm&rdquo;</p>

<p>## Get Environment Variables
 $ZertoOperation = $args[0]
 $ZertoVPGName = $args[1]</p>

<p>if ($ZertoOperation -ne &ldquo;Test&rdquo;){</p>

<p>## Set DNS servers
 $DNSservers= @(&ldquo;192.168.1.1&rdquo;, &ldquo;192.168.1.2&rdquo;)</p>

<p>## Filepath to script and CSV files
 $FP = &ldquo;C:\ZertoScripts\&rdquo;
 CD $FP
 Foreach($DNSserver in $DNSservers)
 {
 Import-CSV .\$ZertoVPGName\DNS-OldA.csv | foreach {
 .\dnscmd $DNSserver /RecordDelete $_.zone $_.hostname A $_.ip /f}
 Import-CSV .\$ZertoVPGName\DNS-NewA.csv | foreach {
 .\dnscmd $DNSserver /RecordAdd $_.zone $_.hostname A $_.ip}
 Import-CSV .\$ZertoVPGName\DNS-OldPTR.csv | foreach {
 .\dnscmd $DNSserver /RecordDelete $_.reversezone $_.lowip PTR $_.fqdn /f}
 Import-CSV .\$ZertoVPGName\DNS-NewPTR.csv | foreach {
 .\dnscmd $DNSserver /RecordAdd $_.reversezone $_.lowip PTR $_.fqdn}
 }</p>

<p>}
 Else {</p>

<p>$LogContent = $ZertoVPGName &ldquo; &rdquo; $timestamp
 Add-Content c:\ZertoScripts\Results\ListOfTestedVPGs.txt -value $LogContent</p>

<p>}</p>

<p>Example contents of the csv files are shown below. Remember these are within subfolders which are named exactly the same as the VPG names. Also note the header line in each file is required:</p>

<p><strong>DNS-NewA.csv:</strong><br>
<code>zone,hostname,ip  
addomain.local,server01,192.168.1.10</code></p>

<p><strong>DNS-NewPTR.csv:</strong><br>
<code>reversezone,lowip PTR,fqdn  
1.168.192.in-addr.arpa,10,server01.addomain.local</code></p>

<p><strong>DNS-OldA.csv:</strong><br>
<code>zone,hostname,ip  
addomain.local,server01,192.168.2.10</code></p>

<p><strong>DNS-OldPTR.csv:</strong><br>
<code>reversezone,lowip PTR,fqdn  
2.168.192.in-addr.arpa,10,server01.addomain.local</code></p>

<p>For convenience you can download the Powershell script and example csv files in a zip(Dnscmd.exe is not included!).<br>
<a href="http://www.neogeek.net/wp-content/uploads/2012/05/ZertoDNSChangeScript.zip"><strong>ZertoDNSChangeScript.zip</strong></a><br>
If you extract this to the “C:\ZertoScripts\” directory and copy Dnscmd.exe to this folder on each ZVM server you will be able to run the script.</p>

<p>I must caveat this post by saying although my initial revision of this script worked and the changes since then are minor, I currently don’t have access to an environment where I can test this. I have requested a trial license, when I get it I will test this script thoroughly and then remove this comment from my post.</p>

<div class='tags'>
<ol>
<li><a class="tag" href="/zerto/">Zerto</a></li>
</ol>
</div>
<section class='post-footer'>
<h1 class='small-h1 post-author-header'>
<div class='post-author clearfix'>
<div class='author-avatar'>
<img src="../images/avatars/steven-johnston.jpg?1439193430" />
</div>
<div class='post-author-details'>
<h1><a href="/steven-johnston">Steven Johnston</a></h1>
<span class='bio'>Tech lover and scripting addict. Focused on virtualisation, storage and data centre networking solutions. VMware / Cisco / EMC.</span>
<span class='author-posts-link'>
<a href="/steven-johnston">View Steven's other posts</a>
</span>
</div>
</div>
</h1>
</section>
<div class='post-nav'>
<div class='previous-post'>
<a href="/20120302-fast-cache8230-its-simple-but-think-first/">← Previous</a>
</div>
<div class='next-post'>
<a href="/20121103-exchange-2013-server-installation-8211-part-1/">Next →</a>
</div>
</div>
</div>
</article>
</div>
</div>
<footer>
<section class='newsletter'>
<div class='layout-wrapper' id='mc-signup'>
<div class='layout-inner'>
<form action='http://novosco.us7.list-manage1.com/subscribe/post?u=9bff1bb397f0ed0fda92caa1a&amp;id=b15b8e54dd' class='validate' id='mc-subscribe-form' method='post' name='mc-embedded-subscribe-form' novalidate='' target='_blank'>
<div class='form-inputs'>
<label for='mc-email'>
<div class='newsletter-title'>
Subscribe to our mailing list
</div>
<input id='mc-email' name='EMAIL' placeholder='Enter your email address…' required='' type='email' value=''>
</label>
</div>
<div class='form-action newsletter-button'>
<input class='button' name='subscribe' type='submit' value='Subscribe'>
</div>
</form>
</div>
</div>
</section>
<section class='footer-info clearfix'>
<div class='layout-wrapper'>
<div class='layout-inner'>
<span class='about-novosco'>
<strong>Novosco</strong>
is a leading provider of Cloud Technologies, Managed Service and Consulting.
</span>
<span class='copyright'>
© 2007-2015 Novosco Ltd
</span>
</div>
</div>
</section>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-44792610-1', 'novosco.com');
  ga('send', 'pageview');
</script>

</body>
</html>
