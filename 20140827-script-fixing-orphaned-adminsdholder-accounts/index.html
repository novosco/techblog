<!DOCTYPE html>
<html dir='ltr' lang='en' xmlns:fb='http://ogp.me/ns/fb#'>
<head>
<link href="../stylesheets/syntax_highlighting.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='text/html;' http-equiv='content-type'>
<title>Script&#58; Fixing Orphaned AdminSDHolder Accounts
 | Novosco Tech Blog</title>
<meta content='index,follow' name='robots'>
<meta content='initial-scale=1.0 maximum-scale=1.0 user-scalable=no' name='viewport'>
<meta content='width=380, maximum-scale=1.0' name='viewport'>
<link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='../images/touch-icon-iphone.png' rel='apple-touch-icon'>
<link href='../images/touch-icon-ipad.png' rel='apple-touch-icon' sizes='72x72'>
<link href='../images/touch-icon-iphone-retina.png' rel='apple-touch-icon' sizes='114x114'>
<link href='../images/touch-icon-ipad-retina.png' rel='apple-touch-icon' sizes='144x144'>
<!--[if lt IE 9]> <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
<link href="../stylesheets/all.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<!-- OG -->
<meta content='Novosco Tech Blog' property='og:title'>
<meta content='website' property='og:type'>
<meta content='../images/novosco-og-icon.png' property='og:image'>
<meta content='http://engineering.novosco.com' property='og:url'>
<meta content='Novosco Tech Blog ' property='og:description'>
<!-- Twitter -->
<meta content='summary' name='twitter:card'>
<meta content='http://engineering.novosco.com' name='twitter:url'>
<meta content='Novosco Tech Blog' name='twitter:title'>
<meta content='Novosco Tech Blog ' name='twitter:description'>
<meta content='../images/novosco-og-icon.png' name='twitter:image'>
<meta content='@novoscoeng' name='twitter:site'>
<meta content='@novosco' name='twitter:creator'>
<meta content='' name='author'>
<!-- Typekit -->
<script src="//use.typekit.net/tjm4emr.js" type="text/javascript"></script>
<script>
  try{Typekit.load();}catch(e){};
  
  window.onload = function() {
    var menu = document.getElementById('menu-button');
    var menu_items = document.getElementById('menu-items');
  
    function toggleMenu(){
      if (menu_items.style.display == "block") {
        menu_items.style.display = 'none';
      } else {
        menu_items.style.display = 'block';
      }
    };
  
    menu.addEventListener('click', function() {
      toggleMenu()
    }, false);
  };
</script>

</head>
<body class='20140827-script-fixing-orphaned-adminsdholder-accounts 20140827-script-fixing-orphaned-adminsdholder-accounts_index'>
<header>
<div class='layout-wrapper'>
<div class='layout-inner'>
<a href="/"><span class='logo'>Novosco Tech Blog</span></a>
<div class='header-nav'>
<nav>
<a href='#' id='menu-button'>
MENU
<img src='/images/menu-triangle.png' width='11px'>
</a>
<ul id='menu-items'>
<li>
<a href="http://www.novosco.com/">Home</a>
</li>
<li>
<a class="active" href="http://cio.novosco.com/">CIO Blog</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</header>

<div class='container'>
<div id='post-main'>
<article class='post-header'>
<h1 class='article-header'>
<a href="/20140827-script-fixing-orphaned-adminsdholder-accounts/">Script&#58; Fixing Orphaned AdminSDHolder Accounts</a>
</h1>
<div class='post-meta'>
<div class='post-avatar'>
<img src="../images/avatars/alan-mcburney.jpg?1439193430" />
</div>
<div class='post-meta-text'>
<span>By <a href="/alan-mcburney">Alan McBurney</a> on</span>
<time>27 August 2014</time>
</div>
</div>

<div class='body'>
<p>This is intended as a follow up to  <a title="Detecting members of Protected Groups within AD" href="http://everythingsysadmin.wordpress.com/2013/07/16/detecting-members-of-protected-groups-within-ad/">Detecting members of Protected Groups within AD</a></p>

<p>It seems that no matter how many Exchange or Lync projects I do I always come across the issue of orphaned AdminSDHolders.</p>

<p>To overcome the tedium of detecting and fixing orphaned users I decided to put together a script to automate the task.</p>

<p>This script gets all users that are members of protected groups within AD and compares membership with users that have the AD Attribute AdminCount=1 set. If the user has the AdminCount=1 enabled but is not a member of a protected group within AD then the user is considered orphaned, the AdminCount is reset to 0 and inheritable permissions are enabled.</p>

<p>&lt;#
 .SYNOPSIS
 Detects Orphaned SD Admin users, resets admin count attribute and enables inheritable permissions</p>

<p>.Author
 Alan.McBurney</p>

<p>THIS CODE IS MADE AVAILABLE AS IS, WITHOUT WARRANTY OF ANY KIND. THE ENTIRE
 RISK OF THE USE OR THE RESULTS FROM THE USE OF THIS CODE REMAINS WITH THE USER.</p>

<p>Version 1.0, July 10th, 2014</p>

<p>.DESCRIPTION
 This script gets all users that are members of protected groups within AD and compares
 membership with users that have the AD Attribute AdminCount=1 set.
 If the user has the AdminCount=1 enabled but is not a member of a protected group then the user
 is considered an orphaned admin user and the AdminCount is reset to 0 and inheritable permissions
 are reset</p>

<p>.REFERENCES
 &ldquo;http://blogs.technet.com/b/heyscriptingguy/archive/2010/07/11/hey-scripting-guy-weekend-scripter-checking-for-module-dependencies-in-windows-powershell.aspx&rdquo;&gt;http://blogs.technet.com/b/heyscriptingguy/archive/2010/07/11/hey-scripting-guy-weekend-scripter-checking-for-module-dependencies-in-windows-powershell.aspx</a>
 &ldquo;http://blogs.msdn.com/b/muaddib/archive/2013/12/30/how-to-modify-security-inheritance-on-active-directory-objects.aspx&rdquo;&gt;http://blogs.msdn.com/b/muaddib/archive/2013/12/30/how-to-modify-security-inheritance-on-active-directory-objects.aspx</a></p>

<p>.EXAMPLE
 Reset-OrphanSDUsers</p>

<p>.Notes
 To Do list: Enable logging
 #&gt;</p>

<p>#Check to Ensure Active Directory PowerShell Module is available within the system
 Function Get-MyModule
 {
 Param([string]$name)
 if(-not(Get-Module -name $name))
 {
 if(Get-Module -ListAvailable |Where-Object { $_.name -eq $name })
 {
 Import-Module -Name $name
 $True | Out-Null
 }
 else
 {
 Write-Host ActiveDirectory PowerShell Module Not Available -ForegroundColor Red
 }
 } # end if not module
 else
 {
 $True | Out-Null
 }   #module already loaded
 } #end function get-MyModule</p>

<p>Get-MyModule -name &ldquo;ActiveDirectory&rdquo;</p>

<p>Function Set-Inheritance
 {
 Param($ObjectPath)
 $Acl = Get-ACL -path &ldquo;AD:\$ObjectPath&rdquo;
 If ($Acl.AreAccessRulesProtected -eq $True)
 {
 $Acl.SetAccessRuleProtection($False, $True)
 Set-ACL -AclObject $ACL -path &ldquo;AD:\$ObjectPath&rdquo;
 }
 }</p>

<p>#Get List of Proected Groups
 $AdminGrp = Get-ADGroup -LDAPFilter &ldquo;(adminCount=1)&rdquo;</p>

<p>#Get List of Admin Users (Past and Present)
 $AdminUsers = Get-ADUser -LDAPFilter &ldquo;(adminCount=1)&rdquo;</p>

<p>$Admins = ForEach ($Grp in $AdminGrp) {Get-ADGroupMember $Grp | Where-Object {$_.ObjectClass -eq &ldquo;User&rdquo;}}</p>

<p>#Create Empty Hash
 $PGUSers = @{}
 $OrphanUsers = @{}</p>

<p>#Compare $AdminUsers to $Admins and place in appropriate hash table
 ForEach ($User in $AdminUsers)
 {
 If ($Admins -Match $User.Name)
 {
 $PGUsers.Add($User.Name, &ldquo;Present&rdquo;)
 }
 Else
 {
 $OrphanUsers.Add($User.SamAccountName, &ldquo;NotPresent&rdquo;)
 }
 }</p>

<p>If ($OrphanUsers.Keys.Count.Equals(0))
 {
 $True | Out-Null
 }
 Else
 {
 #Clear AdminCount Attribute
 ForEach ($Orphan in $OrphanUsers.Keys)
 {
 $Orphan
 $ADUser = Get-ADUser $Orphan
 Set-ADUser $Orphan -Clear {AdminCount}
 Set-Inheritance $ADUser
 }
 }<br>
<a href="http://feeds.wordpress.com/1.0/gocomments/everythingsysadmin.wordpress.com/682/"> <img src="http://feeds.wordpress.com/1.0/comments/everythingsysadmin.wordpress.com/682/" /> </a> <img src="http://pixel.wp.com/b.gif?host=everythingsysadmin.wordpress.com&blog=8998607&post=682&subd=everythingsysadmin&ref=&feed=1" /></p>

<div class='tags'>
<ol>
<li><a class="tag" href="/active-directory/">Active Directory</a></li>
</ol>
</div>
<section class='post-footer'>
<h1 class='small-h1 post-author-header'>
<div class='post-author clearfix'>
<div class='author-avatar'>
<img src="../images/avatars/alan-mcburney.jpg?1439193430" />
</div>
<div class='post-author-details'>
<h1><a href="/alan-mcburney">Alan McBurney</a></h1>
<span class='bio'>Solutions Architect @Novosco. Passionate about technology, delivering Microsoft centric solutions with emphasis on Lync, Exchange, PowerShell and Infrastructure.</span>
<span class='author-posts-link'>
<a href="/alan-mcburney">View Alan's other posts</a>
</span>
</div>
</div>
</h1>
</section>
<div class='post-nav'>
<div class='previous-post'>
<a href="/20140818-automating-powershell-connection-to-office-365/">← Previous</a>
</div>
<div class='next-post'>
<a href="/20140827-script-checking-for-expired-certificates-in-exchange/">Next →</a>
</div>
</div>
</div>
</article>
</div>
</div>
<footer>
<section class='newsletter'>
<div class='layout-wrapper' id='mc-signup'>
<div class='layout-inner'>
<form action='http://novosco.us7.list-manage1.com/subscribe/post?u=9bff1bb397f0ed0fda92caa1a&amp;id=b15b8e54dd' class='validate' id='mc-subscribe-form' method='post' name='mc-embedded-subscribe-form' novalidate='' target='_blank'>
<div class='form-inputs'>
<label for='mc-email'>
<div class='newsletter-title'>
Subscribe to our mailing list
</div>
<input id='mc-email' name='EMAIL' placeholder='Enter your email address…' required='' type='email' value=''>
</label>
</div>
<div class='form-action newsletter-button'>
<input class='button' name='subscribe' type='submit' value='Subscribe'>
</div>
</form>
</div>
</div>
</section>
<section class='footer-info clearfix'>
<div class='layout-wrapper'>
<div class='layout-inner'>
<span class='about-novosco'>
<strong>Novosco</strong>
is a leading provider of Cloud Technologies, Managed Service and Consulting.
</span>
<span class='copyright'>
© 2007-2015 Novosco Ltd
</span>
</div>
</div>
</section>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-44792610-1', 'novosco.com');
  ga('send', 'pageview');
</script>

</body>
</html>
