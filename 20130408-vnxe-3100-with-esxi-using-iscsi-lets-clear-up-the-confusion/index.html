<!DOCTYPE html>
<html dir='ltr' lang='en' xmlns:fb='http://ogp.me/ns/fb#'>
<head>
<link href="../stylesheets/syntax_highlighting.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='text/html;' http-equiv='content-type'>
<title>VNXe 3100 with ESXi using iSCSI, lets clear up the confusion.
 | Novosco Tech Blog</title>
<meta content='index,follow' name='robots'>
<meta content='initial-scale=1.0 maximum-scale=1.0 user-scalable=no' name='viewport'>
<meta content='width=380, maximum-scale=1.0' name='viewport'>
<link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='../images/touch-icon-iphone.png' rel='apple-touch-icon'>
<link href='../images/touch-icon-ipad.png' rel='apple-touch-icon' sizes='72x72'>
<link href='../images/touch-icon-iphone-retina.png' rel='apple-touch-icon' sizes='114x114'>
<link href='../images/touch-icon-ipad-retina.png' rel='apple-touch-icon' sizes='144x144'>
<!--[if lt IE 9]> <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
<link href="../stylesheets/all.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<!-- OG -->
<meta content='Novosco Tech Blog' property='og:title'>
<meta content='website' property='og:type'>
<meta content='../images/novosco-og-icon.png' property='og:image'>
<meta content='http://engineering.novosco.com' property='og:url'>
<meta content='Novosco Tech Blog ' property='og:description'>
<!-- Twitter -->
<meta content='summary' name='twitter:card'>
<meta content='http://engineering.novosco.com' name='twitter:url'>
<meta content='Novosco Tech Blog' name='twitter:title'>
<meta content='Novosco Tech Blog ' name='twitter:description'>
<meta content='../images/novosco-og-icon.png' name='twitter:image'>
<meta content='@novoscoeng' name='twitter:site'>
<meta content='@novosco' name='twitter:creator'>
<meta content='' name='author'>
<!-- Typekit -->
<script src="//use.typekit.net/tjm4emr.js" type="text/javascript"></script>
<script>
  try{Typekit.load();}catch(e){};
  
  window.onload = function() {
    var menu = document.getElementById('menu-button');
    var menu_items = document.getElementById('menu-items');
  
    function toggleMenu(){
      if (menu_items.style.display == "block") {
        menu_items.style.display = 'none';
      } else {
        menu_items.style.display = 'block';
      }
    };
  
    menu.addEventListener('click', function() {
      toggleMenu()
    }, false);
  };
</script>

</head>
<body class='20130408-vnxe-3100-with-esxi-using-iscsi-lets-clear-up-the-confusion 20130408-vnxe-3100-with-esxi-using-iscsi-lets-clear-up-the-confusion_index'>
<header>
<div class='layout-wrapper'>
<div class='layout-inner'>
<a href="/"><span class='logo'>Novosco Tech Blog</span></a>
<div class='header-nav'>
<nav>
<a href='#' id='menu-button'>
MENU
<img src='/images/menu-triangle.png' width='11px'>
</a>
<ul id='menu-items'>
<li>
<a href="http://www.novosco.com/">Home</a>
</li>
<li>
<a class="active" href="http://cio.novosco.com/">CIO Blog</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</header>

<div class='container'>
<div id='post-main'>
<article class='post-header'>
<h1 class='article-header'>
<a href="/20130408-vnxe-3100-with-esxi-using-iscsi-lets-clear-up-the-confusion/">VNXe 3100 with ESXi using iSCSI, lets clear up the confusion.</a>
</h1>
<div class='post-meta'>
<div class='post-avatar'>
<img src="../images/avatars/steven-johnston.jpg?1439193430" />
</div>
<div class='post-meta-text'>
<span>By <a href="/steven-johnston">Steven Johnston</a> on</span>
<time> 8 April 2013</time>
</div>
</div>

<div class='body'>
<p>[<strong>Edit -</strong> I Wrote this blog post a very long time ago but never published it to the public as I felt I needed to address the addition of the SLIC cards to VNXe before I released this into the wild. I have decided to open it up anyway as it is still relevant today in VNXe or even just general iSCSI configurations.]</p>

<p>I do a lot of VNX work and until recently didn’t get an opportunity to deploy a VNXe. As with any product for the first time I did some research in to how it should be configured. It was a VNXe 3100 and would be used with ESXi 5.0 using iSCSI. I searched the web, asked colleagues and the results were that every configuration seemed to be slightly different. Part of the reason behind this is connectivity options. It comes with 2 on-board NICs per Storage Processor but some are also sold with an additional 4 port SLIC card in each SP and it supports link aggregation.</p>

<p></p>

<p>The VNXe is designed to be simple to implement and it is exactly that. The VNXe itself is a very clever box and it is because of this that it’s hard not to implement in a way that will work under most failure situations (thanks in part to FSN). Even if most configurations will allow the VNXe to work, there are still better ways to do things.</p>

<p>Part of the issue with VNXe is that it’s so simple, people who don’t normally dabble with storage solutions implement it and thats when people come up with these unnecessarily elaborate configurations because they aren’t familiar with multipathing, either with VMware ESXi or in general. This inspired me to create this blog post in the hope I can help steer people to the relevent documentation before they deploy their VNXe 3100.</p>

<p>A pre-requesit before even trying to deploy any iSCSI solution with ESXi is to read the VMware guidelines.</p>

<p>Software iSCSI Adapter configuration can be found for ESXi 4.1 and 5.0 in the following places.</p>

<ul>
<li>PG34 of <a href="http://www.vmware.com/pdf/vsphere4/r41/vsp_41_iscsi_san_cfg.pdf">http://www.vmware.com/pdf/vsphere4/r41/vsp_41_iscsi_san_cfg.pdf</a></li>
<li>PG74 of <a href="http://pubs.vmware.com/vsphere-50/topic/com.vmware.ICbase/PDF/vsphere-esxi-vcenter-server-50-storage-guide.pdf">http://pubs.vmware.com/vsphere-50/topic/com.vmware.ICbase/PDF/vsphere-esxi-vcenter-server-50-storage-guide.pdf</a></li>
</ul>

<p> </p>

<p>The part I see people getting wrong time and time again with iSCSI configurations is with VMkernel ports and physical NICs. There should always be a 1 to 1 relationship between these. 1 VMkernel port with an IP to 1 Physical vmnic port. The guides above both show this in two specific configurations.</p>

<ul>
<li>Option 1 – one vSwitch, multiple VMkernel Ports and multiple NICs. (Uses port-binding)<br>
<a href="http://www.neogeek.net/wp-content/uploads/2012/04/vSS-iSCSI-Option1.png"> <img title="vSS iSCSI Option1" src="http://www.neogeek.net/wp-content/uploads/2012/04/vSS-iSCSI-Option1.png" /> </a></li>
<li>Option 2 – A seperate vSwitch for each VMkernel/NIC. (Easiest configuration, no port-binding required)<br>
<a href="http://www.neogeek.net/wp-content/uploads/2012/04/vSS-iSCSI-Option2.png"> <img title="vSS iSCSI Option2" src="http://www.neogeek.net/wp-content/uploads/2012/04/vSS-iSCSI-Option2.png" /> </a></li>
</ul>

<p>There are excellent videos showing Option 1 ( <a href="http://www.youtube.com/watch?v=Mu-HyD3E3cw">http://www.youtube.com/watch?v=Mu-HyD3E3cw</a>) and Option 2 above ( <a href="http://www.youtube.com/watch?v=oKH-DW6HrMc">http://www.youtube.com/watch?v=oKH-DW6HrMc</a>). The videos also show MTU being set for Jumbo frames which is important to help increase performance.</p>

<p>So after grasping the concept of 1-1 vmk to NIC the next question is, “<em>Is one NIC per subnet enough? Shouldn’t we have redundancy at this level?</em>”</p>

<p>If you have the NICs then sure why not but whatever you do, <strong>DO NOT</strong> just add these as Standby NICs. This is not a supported configuration from VMware.</p>

<p>The correct way to do this is to maintain the 1-1 vmk to NIC relationship and if using Option 1 add a NIC for each additional vmk and use port binding as you will already have done. In this setup you can add vmk ports which are in the same subnets as the existing two, i.e. add an additional port in each.</p>

<p>For Option 2 I am lead to believe when two subnets are used, going beyond two vSwitches would be unsupported since a subnet would be required per switch.<br>
The reason behind my opinion on this are the following line from the SAN Config guide on PG77.<br>
“ <code>NOTE If you use separate vSphere switches, you must connect them to different IP subnets. Otherwise,  
VMkernel adapters might experience connectivity problems and the host will fail to discover iSCSI LUNs.</code> “.<br>
I guess a hybrid approach where you have two vmk ports in two vSwitches using port binding would still meet the requirments and be supported as long as the same subnets are used on the two vmk ports in the same vSwitch.</p>

<p>Ultimately the simplest configurations are normally the best and easiest to troubleshoot. The diagram below shows the same config as described in the “EMC VNXe High Availability Overview” white paper. The white paper can be viewed here <a href="https://support1.emc.com/docu35554_White-Paper:-EMC-VNXe-High-Availability.pdf?language=en_US">https://support1.emc.com/docu35554_White-Paper:-EMC-VNXe-High-Availability.pdf?language=en_US</a>. The configuration below provides two pathes to each Datastore and uses the simplest vSphere configuration (Option 2 above). In my opinion if you are using the VNXe3100 without the add-on SLIC cards then its best to adhere to the document and have a deployment as below.</p>

<p> </p>

<p><a href="http://www.neogeek.net/wp-content/uploads/2012/04/VNXe_Failover11.jpg"> <img title="VNXe_Failover1" src="http://www.neogeek.net/wp-content/uploads/2012/04/VNXe_Failover11-1024x654.jpg" /> </a></p>

<div class='tags'>
<ol>
<li><a class="tag" href="/emc/">EMC</a></li>
</ol>
</div>
<section class='post-footer'>
<h1 class='small-h1 post-author-header'>
<div class='post-author clearfix'>
<div class='author-avatar'>
<img src="../images/avatars/steven-johnston.jpg?1439193430" />
</div>
<div class='post-author-details'>
<h1><a href="/steven-johnston">Steven Johnston</a></h1>
<span class='bio'>Tech lover and scripting addict. Focused on virtualisation, storage and data centre networking solutions. VMware / Cisco / EMC.</span>
<span class='author-posts-link'>
<a href="/steven-johnston">View Steven's other posts</a>
</span>
</div>
</div>
</h1>
</section>
<div class='post-nav'>
<div class='previous-post'>
<a href="/20130404-creating-cluster-resources-for-exchange-2007-scc/">← Previous</a>
</div>
<div class='next-post'>
<a href="/20130408-change-windows-2012-server-edition/">Next →</a>
</div>
</div>
</div>
</article>
</div>
</div>
<footer>
<section class='newsletter'>
<div class='layout-wrapper' id='mc-signup'>
<div class='layout-inner'>
<form action='http://novosco.us7.list-manage1.com/subscribe/post?u=9bff1bb397f0ed0fda92caa1a&amp;id=b15b8e54dd' class='validate' id='mc-subscribe-form' method='post' name='mc-embedded-subscribe-form' novalidate='' target='_blank'>
<div class='form-inputs'>
<label for='mc-email'>
<div class='newsletter-title'>
Subscribe to our mailing list
</div>
<input id='mc-email' name='EMAIL' placeholder='Enter your email address…' required='' type='email' value=''>
</label>
</div>
<div class='form-action newsletter-button'>
<input class='button' name='subscribe' type='submit' value='Subscribe'>
</div>
</form>
</div>
</div>
</section>
<section class='footer-info clearfix'>
<div class='layout-wrapper'>
<div class='layout-inner'>
<span class='about-novosco'>
<strong>Novosco</strong>
is a leading provider of Cloud Technologies, Managed Service and Consulting.
</span>
<span class='copyright'>
© 2007-2015 Novosco Ltd
</span>
</div>
</div>
</section>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-44792610-1', 'novosco.com');
  ga('send', 'pageview');
</script>

</body>
</html>
