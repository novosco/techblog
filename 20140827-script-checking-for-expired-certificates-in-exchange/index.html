<!DOCTYPE html>
<html dir='ltr' lang='en' xmlns:fb='http://ogp.me/ns/fb#'>
<head>
<link href="../stylesheets/syntax_highlighting.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='text/html;' http-equiv='content-type'>
<title>Script&#58; Checking for Expired Certificates in Exchange
 | Novosco Tech Blog</title>
<meta content='index,follow' name='robots'>
<meta content='initial-scale=1.0 maximum-scale=1.0 user-scalable=no' name='viewport'>
<meta content='width=380, maximum-scale=1.0' name='viewport'>
<link href='/favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='../images/touch-icon-iphone.png' rel='apple-touch-icon'>
<link href='../images/touch-icon-ipad.png' rel='apple-touch-icon' sizes='72x72'>
<link href='../images/touch-icon-iphone-retina.png' rel='apple-touch-icon' sizes='114x114'>
<link href='../images/touch-icon-ipad-retina.png' rel='apple-touch-icon' sizes='144x144'>
<!--[if lt IE 9]> <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
<link href="../stylesheets/all.css?1439193430" media="screen" rel="stylesheet" type="text/css" />
<!-- OG -->
<meta content='Novosco Tech Blog' property='og:title'>
<meta content='website' property='og:type'>
<meta content='../images/novosco-og-icon.png' property='og:image'>
<meta content='http://engineering.novosco.com' property='og:url'>
<meta content='Novosco Tech Blog ' property='og:description'>
<!-- Twitter -->
<meta content='summary' name='twitter:card'>
<meta content='http://engineering.novosco.com' name='twitter:url'>
<meta content='Novosco Tech Blog' name='twitter:title'>
<meta content='Novosco Tech Blog ' name='twitter:description'>
<meta content='../images/novosco-og-icon.png' name='twitter:image'>
<meta content='@novoscoeng' name='twitter:site'>
<meta content='@novosco' name='twitter:creator'>
<meta content='' name='author'>
<!-- Typekit -->
<script src="//use.typekit.net/tjm4emr.js" type="text/javascript"></script>
<script>
  try{Typekit.load();}catch(e){};
  
  window.onload = function() {
    var menu = document.getElementById('menu-button');
    var menu_items = document.getElementById('menu-items');
  
    function toggleMenu(){
      if (menu_items.style.display == "block") {
        menu_items.style.display = 'none';
      } else {
        menu_items.style.display = 'block';
      }
    };
  
    menu.addEventListener('click', function() {
      toggleMenu()
    }, false);
  };
</script>

</head>
<body class='20140827-script-checking-for-expired-certificates-in-exchange 20140827-script-checking-for-expired-certificates-in-exchange_index'>
<header>
<div class='layout-wrapper'>
<div class='layout-inner'>
<a href="/"><span class='logo'>Novosco Tech Blog</span></a>
<div class='header-nav'>
<nav>
<a href='#' id='menu-button'>
MENU
<img src='/images/menu-triangle.png' width='11px'>
</a>
<ul id='menu-items'>
<li>
<a href="http://www.novosco.com/">Home</a>
</li>
<li>
<a class="active" href="http://cio.novosco.com/">CIO Blog</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
</header>

<div class='container'>
<div id='post-main'>
<article class='post-header'>
<h1 class='article-header'>
<a href="/20140827-script-checking-for-expired-certificates-in-exchange/">Script&#58; Checking for Expired Certificates in Exchange</a>
</h1>
<div class='post-meta'>
<div class='post-avatar'>
<img src="../images/avatars/alan-mcburney.jpg?1439193430" />
</div>
<div class='post-meta-text'>
<span>By <a href="/alan-mcburney">Alan McBurney</a> on</span>
<time>27 August 2014</time>
</div>
</div>

<div class='body'>
<p>I was working with a customer that had unintentionally let their Exchange certificates expire.</p>

<p>This resulted in a bit of a headache for the team as users were now getting certificate warnings and mobility services were down until the certificate was replaced.</p>

<p>I decided to put together a script that will check and warn about expired or soon to expire certificates.<br>
The script gets the certificates which have services bound to them on all Exchange 2010 client access and hub transport servers.<br>
It checks for certificates that have expired or that will expire within the next 60 days and optionally emails the report and creates a schedule task.<br>
An email will only be generated if expired\expiring certificates have been detected</p>

<p>&lt;#
 .SYNOPSIS
 Detects expired certificates on Exchange 2010 Client Access &amp; Hub Transport servers
  
 .Author
 Alan.McBurney
  
 THIS CODE IS MADE AVAILABLE AS IS, WITHOUT WARRANTY OF ANY KIND. THE ENTIRE
 RISK OF THE USE OR THE RESULTS FROM THE USE OF THIS CODE REMAINS WITH THE USER.
  
 Version 1.0, August 27th, 2014
  
 .DESCRIPTION
 This script will get the certificates which have services bound to them on all Exchange 2010
 client access and hub transport servers.
 It checks the expiration for any certificates that are due to expire within 60 days and optionally
 emails the report and creates a schedule task
 An email will only be generated if expired\expiring certificates have been detected
  
 .REFERENCES
 Parameters, checks and scheduled tasks stolen from Steve Goodman&rsquo;s Exchange Environmental Reports script
  
 http://gallery.technet.microsoft.com/exchange/Generate-Exchange-2388e7c9  
 .Notes
 To Do list: Enable Autnetication for SMTP
 Support for Exchange 2007 &amp; 2013
  
 .PARAMETER SendMail
 Send Mail after completion. Set to $True to enable. If enabled, -MailFrom, -MailTo, -MailServer are mandatory
  
 .PARAMETER MailFrom
 Email address to send from. Passed directly to Send-MailMessage as -From
  
 .PARAMETER MailTo
 Email address to send to. Passed directly to Send-MailMessage as -To
  
 .PARAMETER MailServer
 SMTP Mail server to attempt to send through. Passed directly to Send-MailMessage as -SmtpServer
  
 .PARAMETER ScheduleAs
 Attempt to schedule the command just executed weekly. Specify the username here, schtasks (under the hood) will ask for a password later.
  
 .EXAMPLE
 Get-ExpiringEx2K10Certs
 #&gt;
  
 param(
 [parameter(Position=1,Mandatory=$false,ValueFromPipeline=$false,HelpMessage=&lsquo;Send Mail ($True/$False)&rsquo;)][bool]$SendMail=$false,
 [parameter(Position=2,Mandatory=$false,ValueFromPipeline=$false,HelpMessage=&lsquo;Mail From&rsquo;)][string]$MailFrom,
 [parameter(Position=3,Mandatory=$false,ValueFromPipeline=$false,HelpMessage=&lsquo;Mail To&rsquo;)]$MailTo,
 [parameter(Position=4,Mandatory=$false,ValueFromPipeline=$false,HelpMessage=&lsquo;Mail Server&rsquo;)][string]$MailServer,
 [parameter(Position=5,Mandatory=$false,ValueFromPipeline=$false,HelpMessage=&lsquo;Schedule as user&rsquo;)][string]$ScheduleAs
 )
  
 #Check Powershell Version
 if ((Get-Host).Version.Major -eq 1)
 {
 throw &ldquo;Powershell Version 1 not supported&rdquo;;
 }
  
 #Check Exchange Management Shell, attempt to load
 if (!(Get-Command Get-ExchangeServer -ErrorAction SilentlyContinue))
 {
 if (Test-Path &ldquo;C:\Program Files\Microsoft\Exchange Server\V14\bin\RemoteExchange.ps1&rdquo;)
 {
 .&lsquo;C:\Program Files\Microsoft\Exchange Server\V14\bin\RemoteExchange.ps1&rsquo;
 Connect-ExchangeServer -auto
 } elseif (Test-Path &ldquo;C:\Program Files\Microsoft\Exchange Server\bin\Exchange.ps1&rdquo;) {
 Add-PSSnapIn Microsoft.Exchange.Management.PowerShell.Admin
 .&lsquo;C:\Program Files\Microsoft\Exchange Server\bin\Exchange.ps1&rsquo;
 } else {
 throw &ldquo;Exchange Management Shell cannot be loaded&rdquo;
 }
 }
  
 # Check if -SendMail parameter set and if so check -MailFrom, -MailTo and -MailServer are set
 if ($SendMail)
 {
 if (!$MailFrom -or !$MailTo -or !$MailServer)
 {
 throw &ldquo;If -SendMail specified, you must also specify -MailFrom, -MailTo and -MailServer&rdquo;
 }
 }
  
 $Path=Get-Location
 $Dir=$Path.ToString()
 $HTMLReport = $Dir + &ldquo;\ExpiredCerts.html&rdquo;
 $CASServers = Get-ExchangeServer | Where-Object {$_.AdminDisplayVersion -match &ldquo;Version 14&rdquo; -and $_.ServerRole -match [regex] &lsquo;Hub|Client&rsquo;}
 $Certs = Foreach ($srv in $CASServers) {Get-ExchangeCertificate -Server $srv| Where-Object {$_.NotAfter -le (Get-Date).AddDays(60) -and $_.Services -ne &ldquo;None&rdquo;} | Select @{n=&ldquo;Server&rdquo;;e={$srv.name}}, @{n=&ldquo;Expiry Date&rdquo;;e={$_.NotAfter}}, Thumbprint, Services, Issuer, Subject}
 $Certs | ConvertTo-Html | Out-File $HTMLReport
  </p>

<p>if ($SendMail)
 {
 if ($Certs.count -gt 0)
   { 
   Send-MailMessage -Attachments $HTMLReport -To $MailTo -From $MailFrom -Subject &ldquo;Warning - Expired Exchange Certificates Detected&rdquo; -Body &ldquo;Expired or soon to be expired certificates have been detected on Exchange Servers. Please see attached file for certificates affected&rdquo; -SmtpServer $MailServer
   }
 }
  
 if ($ScheduleAs)
 {
 if ($SendMail)
 {
 $params+=&lsquo; -SendMail:$true&rsquo;
 $params+=&ldquo; -MailFrom:$MailFrom -MailTo:$MailTo -MailServer:$MailServer&rdquo;
 }
 $task = &ldquo;powershell -c \&rdquo;&ldquo;pushd $dir; $($myinvocation.mycommand.definition) $params\&rdquo;&ldquo;&rdquo;
 schtasks /Create /RU $ScheduleAs /RP /SC WEEKLY /ST 22:00 /TN ExpiredCerts /TR $task
 }<br>
<a href="http://feeds.wordpress.com/1.0/gocomments/everythingsysadmin.wordpress.com/705/"> <img src="http://feeds.wordpress.com/1.0/comments/everythingsysadmin.wordpress.com/705/" /> </a> <img src="http://pixel.wp.com/b.gif?host=everythingsysadmin.wordpress.com&blog=8998607&post=705&subd=everythingsysadmin&ref=&feed=1" /></p>

<div class='tags'>
<ol>
<li><a class="tag" href="/certificates/">Certificates</a></li>
</ol>
</div>
<section class='post-footer'>
<h1 class='small-h1 post-author-header'>
<div class='post-author clearfix'>
<div class='author-avatar'>
<img src="../images/avatars/alan-mcburney.jpg?1439193430" />
</div>
<div class='post-author-details'>
<h1><a href="/alan-mcburney">Alan McBurney</a></h1>
<span class='bio'>Solutions Architect @Novosco. Passionate about technology, delivering Microsoft centric solutions with emphasis on Lync, Exchange, PowerShell and Infrastructure.</span>
<span class='author-posts-link'>
<a href="/alan-mcburney">View Alan's other posts</a>
</span>
</div>
</div>
</h1>
</section>
<div class='post-nav'>
<div class='previous-post'>
<a href="/20140827-script-fixing-orphaned-adminsdholder-accounts/">← Previous</a>
</div>
<div class='next-post'>
<a href="/20140829-ps-script-auto-generating-new-extensions-in-lync/">Next →</a>
</div>
</div>
</div>
</article>
</div>
</div>
<footer>
<section class='newsletter'>
<div class='layout-wrapper' id='mc-signup'>
<div class='layout-inner'>
<form action='http://novosco.us7.list-manage1.com/subscribe/post?u=9bff1bb397f0ed0fda92caa1a&amp;id=b15b8e54dd' class='validate' id='mc-subscribe-form' method='post' name='mc-embedded-subscribe-form' novalidate='' target='_blank'>
<div class='form-inputs'>
<label for='mc-email'>
<div class='newsletter-title'>
Subscribe to our mailing list
</div>
<input id='mc-email' name='EMAIL' placeholder='Enter your email address…' required='' type='email' value=''>
</label>
</div>
<div class='form-action newsletter-button'>
<input class='button' name='subscribe' type='submit' value='Subscribe'>
</div>
</form>
</div>
</div>
</section>
<section class='footer-info clearfix'>
<div class='layout-wrapper'>
<div class='layout-inner'>
<span class='about-novosco'>
<strong>Novosco</strong>
is a leading provider of Cloud Technologies, Managed Service and Consulting.
</span>
<span class='copyright'>
© 2007-2015 Novosco Ltd
</span>
</div>
</div>
</section>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-44792610-1', 'novosco.com');
  ga('send', 'pageview');
</script>

</body>
</html>
